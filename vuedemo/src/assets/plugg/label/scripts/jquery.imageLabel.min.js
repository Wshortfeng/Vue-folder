"use strict";

function imageLabel(e) {
	var mycontent = e
	var vuethat = e.vuethat

	function a() {
		function e() { //该函数是判断出面积最小的矩形放在最上层
			var e = $(".imageLabel-imgdrop"),
				a = [];
			e.each(function(e, i) { //i 对应画出来的每一个矩形
					var n = $(i).width() * $(i).height();
					a.push(n)
				}),
				e.each(function(e, i) {
					var n = $(i),
						t = n.width() * n.height(),
						l = 0;
					$.each(a, function(e, a) {
						t <= a && l++
					}), n.css({
						"z-index": l
					})
				})
		}
		function a() { //使得底层图片完全显示在视图中
			var e = $(".imageLabel-img"),
				a = $(".imageLabel-jisuan"),
				i = e[0].naturalWidth,
				n = e[0].naturalHeight,
				t = e.parents(".imageLabel-img-body").width(),
				l = e.parents(".imageLabel-img-body").height();
			i / n > t / l ? a.css({
				width: "100%",
				height: n / i * t
			}) : a.css({
				height: "100%",
				width: i / n * l
			})
		}

		function chide() { // 显示拖拽的四个点
			$(".imageLabel-imgdrop").off()
//			$('.imageLable-i-s').hide()
			$(".imageLabel-imgdrop").on('mouseenter', function() {
				$(this).find('.imageLable-i-s').show()
			}).on('mouseleave', function() {
				$(this).find('.imageLable-i-s').hide()
			})
		}
		var t, s, o, d, c, g, m, r = $(".imageLabel-content"),
			b = !1,
			p = !1,
			v = !1,
			f = $(".imageLabel-drap-menu");

		$(".imageLabel-content")[0].oncontextmenu = function() {
				return !1
			},
			f[0].oncontextmenu = function() {
				return !1
			},
			$("body").click(function(e) { //点击body 鼠标右键显示的框关闭
				f.hide()
			}), //imageLabel 入参
			$.each(n.data, function(e, a) {
				s = $('<div class="imageLabel-imgdrop ' + (a.name ? "imageLabel-drop-has" : "") + '"><span class="imageLabel-imgdrop-font">' + (a.name || "") + '</span><div class="imageLable-i-s"></div></div>');
				for(var i = 0; i < 4; i++) s.find(".imageLable-i-s").append('<i class="imageLable-i">');
				if(n.shade)
					for(var t = 0; t < 4; t++) s.append('<em class="imageLable-em">');
				var l = a;
				s.css({
					left: 100 * (l.ex - l.x > 0 ? l.x : l.ex) + "%",
					top: 100 * (l.ey - l.y > 0 ? l.y : l.ey) + "%",
					width: 100 * Math.abs(l.ex - l.x) + "%",
					height: 100 * Math.abs(l.ey - l.y) + "%"
				}).attr("data-json", JSON.stringify(a)), r.append(s)
			}),
			e()
		$(".imageLabel-content").mousedown(function(e) {
				vuethat.isModify = "1"
				if(d = e.button, 2 != e.button) {
					f.hide()
					b = !0
					r = $(this)
					t = {
						x: r.offset().left,
						y: r.offset().top,
						cx: e.clientX,
						cy: e.clientY,
						w: r.width(),
						h: r.height()
					}
					o = {
						x: (t.cx - t.x) / t.w,
						y: (t.cy - t.y) / t.h,
						ex: (t.cx - t.x) / t.w,
						ey: (t.cy - t.y) / t.h
					}
					if($(e.target).hasClass("imageLabel-imgdrop")) {
						p = !0
						s = $(e.target)
						c = JSON.parse(s.attr("data-json"))
						o = $.extend({}, c)
						n.startArea();
						if($(e.target)[0].tagName == "IMG") {
							vuethat.clickType = "img"
							return false;
						} else if($(e.target).hasClass("xian1")) {
							vuethat.clickType = "xian1"
						} else if($(e.target).hasClass("xian2")) {
							vuethat.clickType = "xian2"
						} else if($(e.target).hasClass("kuang")) {
							vuethat.clickType = "kuang"
						}
					} else if($(e.target).hasClass("imageLable-i")) {
						v = !0
						g = $(e.target)
						s = $(e.target).parents(".imageLabel-imgdrop")
						c = JSON.parse(s.attr("data-json"))
						o = $.extend({}, c);
						if($(e.target).parents(".imageLabel-imgdrop").hasClass("xian1")) {
							vuethat.clickType = "xian1"
						} else if($(e.target).parents(".imageLabel-imgdrop").hasClass("xian2")) {
							vuethat.clickType = "xian2"
						} else if($(e.target).parents(".imageLabel-imgdrop").hasClass("kuang")) {
							vuethat.clickType = "kuang"
						}
					} else {
						vuethat.clickType = ""
						m = (new Date).getTime()
						p = !1
						if(vuethat.labelIds.indexOf(vuethat.labelId) > -1) {
							var idIndex = vuethat.labelIds.indexOf(vuethat.labelId)
							vuethat.labelCounts[idIndex].push("")
							var imageIndex = vuethat.labelCounts[idIndex].length - 1
						} else {
							vuethat.labelIds.push(vuethat.labelId)
							var labelNames = {}
							var imageIndex = 0
							labelNames.name = vuethat.toolName
							labelNames.src = vuethat.imageSrc
							vuethat.labelNames.push(labelNames)
							vuethat.labelCounts.push([""])
						}
						if(vuethat.imageType == 1) {
							s = $('<img src="' + vuethat.imageSrc + '" class="imageLabel-imgdrop dian" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" >');
							s.css({
								left: 100 * o.x + "%",
								top: 100 * o.y + "%"
							})
							if(n.shade) {
								for(var i = 0; i < 4; i++) s.append('<em class="imageLable-em">');
							}
							s.addClass("imageLabel-drop-edit").appendTo(r)
							s.siblings().removeClass("imageLabel-drop-edit")
						} else if(vuethat.imageType == 2) {
							if(vuethat.lineType == 1) {
								s = $('<div class="imageLabel-imgdrop imageLabel-transverse imageLabel-fine imageLabel-solid xian1" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 2) {
								s = $('<div class="imageLabel-imgdrop imageLabel-transverse imageLabel-crude imageLabel-solid xian1" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 3) {
								s = $('<div class="imageLabel-imgdrop imageLabel-transverse imageLabel-fine imageLabel-dashed xian1" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 4) {
								s = $('<div class="imageLabel-imgdrop imageLabel-transverse imageLabel-crude imageLabel-dashed xian1" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 5) {
								s = $('<div class="imageLabel-imgdrop imageLabel-vertical imageLabel-fine imageLabel-solid xian2" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 6) {
								s = $('<div class="imageLabel-imgdrop imageLabel-vertical imageLabel-crude imageLabel-solid xian2" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 7) {
								s = $('<div class="imageLabel-imgdrop imageLabel-vertical imageLabel-fine imageLabel-dashed xian2" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 8) {
								s = $('<div class="imageLabel-imgdrop imageLabel-vertical imageLabel-crude imageLabel-dashed xian2" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							}
							s.css({
								left: 100 * o.x + "%",
								top: 100 * o.y + "%"
							})
							for(var a = 0; a < 2; a++) s.find(".imageLable-i-s").append('<i class="imageLable-i">');
							if(n.shade) {
								for(var i = 0; i < 4; i++) s.append('<em class="imageLable-em">');
							}
							s.addClass("imageLabel-drop-edit").appendTo(r)
							s.siblings().removeClass("imageLabel-drop-edit")
						} else if(vuethat.imageType == 3) {
							if(vuethat.lineType == 9) {
								s = $('<div class="imageLabel-imgdrop imageLabel-finek imageLabel-solid kuang" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 10) {
								s = $('<div class="imageLabel-imgdrop imageLabel-crudek imageLabel-solid kuang" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 11) {
								s = $('<div class="imageLabel-imgdrop imageLabel-finek imageLabel-dashed kuang" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							} else if(vuethat.lineType == 12) {
								s = $('<div class="imageLabel-imgdrop imageLabel-crudek imageLabel-dashed kuang" labelId="' + vuethat.labelId + '" imageIndex="' + imageIndex + '" ><div class="imageLable-i-s" ></div></div>');
							}
							s.css({
								left: 100 * o.x + "%",
								top: 100 * o.y + "%"
							})
							for(var a = 0; a < 4; a++) {
								s.find(".imageLable-i-s").append('<i class="imageLable-i">');
							}
							if(n.shade) {
								for(var i = 0; i < 4; i++) s.append('<em class="imageLable-em">');
							}
							s.addClass("imageLabel-drop-edit").appendTo(r)
							s.siblings().removeClass("imageLabel-drop-edit")
						}
						vuethat.imageLabelChange()
					}
					s.addClass("imageLabel-drop-now")
					n.only && $(this).find(".imageLabel-imgdrop").hide()
				} else {
					$(e.target).hasClass("imageLabel-imgdrop") && (s = $(e.target), setTimeout(function() {
						f.css({
							left: e.clientX,
							top: e.clientY
						}).show()
					}, 0))
				}
			}),
			$(".imageLabel-img-boxs").mousemove(function(e) {
				if(b) {
					if(vuethat.imageType == 1 && vuethat.clickType == "") { // 点击的是图片移动
						o.x = (e.clientX - t.x) / t.w
						o.y = (e.clientY - t.y) / t.h
						o.y < 0 && (o.y = 0)
						o.x < 0 && (o.x = 0)
						o.y > 1 && (o.y = 1)
						o.x > 1 && (o.x = 1)
						s.css({
							left: 100 * o.x + "%",
							top: 100 * o.y + "%"
						}).addClass("imageLabel-drop-move")
					} else if(vuethat.imageType == "2" && vuethat.clickType == "") {
						o.ex = (e.clientX - t.x) / t.w
						o.ey = (e.clientY - t.y) / t.h;
						o.y < 0 && (o.y = 0)
						o.x < 0 && (o.x = 0)
						o.ey < 0 && (o.ey = 0)
						o.ex < 0 && (o.ex = 0)
						o.ey > 1 && (o.ey = 1)
						o.ex > 1 && (o.ex = 1)
						o.y > 1 && (o.y = 1)
						o.x > 1 && (o.x = 1)
						if(vuethat.lineType == "1" || vuethat.lineType == "2" || vuethat.lineType == "3" || vuethat.lineType == "4") {
							s.css({
								left: 100 * (o.ex - o.x > 0 ? o.x : o.ex) + "%",
								top: 100 * o.y + "%",
								width: 100 * Math.abs(o.ex - o.x) + "%"
							}).addClass("imageLabel-drop-move")
						} else if(vuethat.lineType == "5" || vuethat.lineType == "6" || vuethat.lineType == "7" || vuethat.lineType == "8") {
							s.css({
								left: 100 * o.x + "%",
								top: 100 * (o.ey - o.y > 0 ? o.y : o.ey) + "%",
								height: 100 * Math.abs(o.ey - o.y) + "%"
							}).addClass("imageLabel-drop-move")
						}
					} else if(vuethat.imageType == "3" && vuethat.clickType == "") {
						o.ex = (e.clientX - t.x) / t.w
						o.ey = (e.clientY - t.y) / t.h;
						o.y < 0 && (o.y = 0)
						o.x < 0 && (o.x = 0)
						o.ey < 0 && (o.ey = 0)
						o.ex < 0 && (o.ex = 0)
						o.ey > 1 && (o.ey = 1)
						o.ex > 1 && (o.ex = 1)
						o.y > 1 && (o.y = 1)
						o.x > 1 && (o.x = 1)
						s.css({
							left: 100 * (o.ex - o.x > 0 ? o.x : o.ex) + "%",
							top: 100 * o.y + "%",
							width: 100 * Math.abs(o.ex - o.x) + "%",
							height: 100 * Math.abs(o.ey - o.y) + "%"
						}).addClass("imageLabel-drop-move")
					} else if(vuethat.clickType == "img") { // 点击的是图片移动
						o.x = (e.clientX - t.x) / t.w
						o.y = (e.clientY - t.y) / t.h
						o.y < 0 && (o.y = 0)
						o.x < 0 && (o.x = 0)
						o.y > 1 && (o.y = 1)
						o.x > 1 && (o.x = 1)
						s.css({
							left: 100 * o.x + "%",
							top: 100 * o.y + "%"
						}).addClass("imageLabel-drop-move")
					} else if(vuethat.clickType == "xian1") {
						if(p) {
							o.x = c.x + (e.clientX - t.cx) / t.w
							o.ex = c.ex + (e.clientX - t.cx) / t.w
							o.y = c.y + (e.clientY - t.cy) / t.h
							o.ey = o.y + 6;
						} else if(v) {
							var a = g.index();
							0 == a && (o.ex = c.ex + (e.clientX - t.cx) / t.w)
							1 == a && (o.x = c.x + (e.clientX - t.cx) / t.w)
						}
						o.y < 0 && (o.y = 0)
						o.x < 0 && (o.x = 0)
						o.ey < 0 && (o.ey = 0)
						o.ex < 0 && (o.ex = 0)
						o.ey > 1 && (o.ey = 1)
						o.ex > 1 && (o.ex = 1)
						o.y > 1 && (o.y = 1)
						o.x > 1 && (o.x = 1)
						s.css({
							left: 100 * (o.ex - o.x > 0 ? o.x : o.ex) + "%",
							top: 100 * o.y + "%",
							width: 100 * Math.abs(o.ex - o.x) + "%"
						}).addClass("imageLabel-drop-move")
					} else if(vuethat.clickType == 'xian2') {
						if(p) {
							o.x = c.x + (e.clientX - t.cx) / t.w
							o.ex = o.x + 6
							o.y = c.y + (e.clientY - t.cy) / t.h
							o.ey = c.ey + (e.clientY - t.cy) / t.h;
						} else if(v) {
							var a = g.index();
							0 == a && (o.y = c.y + (e.clientY - t.cy) / t.h)
							1 == a && (o.ey = c.ey + (e.clientY - t.cy) / t.h)
						}
						o.y < 0 && (o.y = 0)
						o.x < 0 && (o.x = 0)
						o.ey < 0 && (o.ey = 0)
						o.ex < 0 && (o.ex = 0)
						o.ey > 1 && (o.ey = 1)
						o.ex > 1 && (o.ex = 1)
						o.y > 1 && (o.y = 1)
						o.x > 1 && (o.x = 1)
						s.css({
							left: 100 * o.x + "%",
							top: 100 * (o.ey - o.y > 0 ? o.y : o.ey) + "%",
							height: 100 * Math.abs(o.ey - o.y) + "%"
						}).addClass("imageLabel-drop-move")
					} else if(vuethat.clickType == 'kuang') {
						if(p) {
							o.x = c.x + (e.clientX - t.cx) / t.w
							o.ex = c.ex + (e.clientX - t.cx) / t.w
							o.y = c.y + (e.clientY - t.cy) / t.h
							o.ey = c.ey + (e.clientY - t.cy) / t.h;
						} else if(v) {
							var a = g.index();
							0 == a && (o.x = c.x + (e.clientX - t.cx) / t.w, o.y = c.y + (e.clientY - t.cy) / t.h)
							1 == a && (o.ex = c.ex + (e.clientX - t.cx) / t.w, o.y = c.y + (e.clientY - t.cy) / t.h)
							2 == a && (o.ex = c.ex + (e.clientX - t.cx) / t.w, o.ey = c.ey + (e.clientY - t.cy) / t.h)
							3 == a && (o.x = c.x + (e.clientX - t.cx) / t.w, o.ey = c.ey + (e.clientY - t.cy) / t.h)
							4 == a && (o.y = c.y + (e.clientY - t.cy) / t.h)
							5 == a && (o.ex = c.ex + (e.clientX - t.cx) / t.w)
							6 == a && (o.ey = c.ey + (e.clientY - t.cy) / t.h)
							7 == a && (o.x = c.x + (e.clientX - t.cx) / t.w)
						}
						o.y < 0 && (o.y = 0)
						o.x < 0 && (o.x = 0)
						o.ey < 0 && (o.ey = 0)
						o.ex < 0 && (o.ex = 0)
						o.ey > 1 && (o.ey = 1)
						o.ex > 1 && (o.ex = 1)
						o.y > 1 && (o.y = 1)
						o.x > 1 && (o.x = 1)
						s.css({
							left: 100 * (o.ex - o.x > 0 ? o.x : o.ex) + "%",
							top: 100 * (o.ey - o.y > 0 ? o.y : o.ey) + "%",
							height: 100 * Math.abs(o.ey - o.y) + "%",
							width: 100 * Math.abs(o.ex - o.x) + "%"
						}).addClass("imageLabel-drop-move")
					}
				}
			}).mouseup(function(a) {
				if(b) {
					var i = {};
					if(vuethat.imageType == 1 || vuethat.clickType == "img") {
						i.x = o.x
						i.y = o.y
					} else if(vuethat.imageType == "2" || vuethat.clickType == "xian1" || vuethat.clickType == "xian2") {
						o.x < o.ex ? (i.x = o.x, i.ex = o.ex) : (i.x = o.ex, i.ex = o.x)
						o.y < o.ey ? (i.y = o.y, i.ey = o.ey) : (i.y = o.ey, i.ey = o.y)
						i.lineType = vuethat.lineType
					} else if(vuethat.imageType == "3" || vuethat.clickType == "kuang") {
						o.x < o.ex ? (i.x = o.x, i.ex = o.ex) : (i.x = o.ex, i.ex = o.x)
						o.y < o.ey ? (i.y = o.y, i.ey = o.ey) : (i.y = o.ey, i.ey = o.y)
						i.lineType = vuethat.lineType
					}
					s.attr("data-json", JSON.stringify($.extend(o, i))), !p && !v ? (n.editPop && ($(".imageLabel-input").addClass("imageLabel-active").find("input").val(""),$(".imageLabel-input-ok").click(), setTimeout(function() {
//					s.attr("data-json", JSON.stringify($.extend(o, i))), !p && !v ? (n.editPop && ($(".imageLabel-input").find("input").val(""), setTimeout(function() {
						$(".imageLabel-input").find("input").focus()[0].setSelectionRange(-1, -1)
					}, 500)), n.edit(s)) : p || v || s.remove()
					b = !1
					p = !1
					v = !1
					e()
					s.removeClass("imageLabel-drop-now imageLabel-drop-move")
				}
				n.only && $(this).find(".imageLabel-imgdrop").show()
			}),
			chide();
		var y = $(".imageLabel-input"),
			u = y.find("input");
		y.find(".imageLabel-input-close").click(function() {
				chide()
				var e = JSON.parse(s.attr("data-json"));
				e.name = u.val()
				e.type = vuethat.imageType
				e.imageSrc = vuethat.imageSrc
				e.labelId = vuethat.labelId
				e.toolName = vuethat.toolName
				s.attr("data-json", JSON.stringify(e)), y.removeClass("imageLabel-active"), u.val() ? s.addClass("imageLabel-drop-has") : s.removeClass("imageLabel-drop-has")
				$(".imageLabel-drop-edit").removeClass("imageLabel-drop-edit")
				var labelId = s.attr("labelId")
				var labelIdIndex = vuethat.labelIds.indexOf(labelId)
				var imageIndex = s.attr("imageIndex")
				vuethat.labelCounts[labelIdIndex][imageIndex] = u.val()
				var aa = vuethat.labelCounts
				vuethat.labelCounts = []
				vuethat.labelCounts = aa
			}), y.find(".imageLabel-input-ok").click(function() {
				chide()
				var e = JSON.parse(s.attr("data-json"));
				e.name = u.val()
				e.type = vuethat.imageType
				e.imageSrc = vuethat.imageSrc
				e.labelId = vuethat.labelId
				e.toolName = vuethat.toolName
				s.attr("data-json", JSON.stringify(e)), y.removeClass("imageLabel-active"), u.val() ? s.addClass("imageLabel-drop-has") : s.removeClass("imageLabel-drop-has")
				$(".imageLabel-drop-edit").removeClass("imageLabel-drop-edit")
				var labelId = s.attr("labelId")
				var labelIdIndex = vuethat.labelIds.indexOf(labelId)
				var imageIndex = s.attr("imageIndex")
				vuethat.labelCounts[labelIdIndex][imageIndex] = u.val()
				var aa = vuethat.labelCounts
				vuethat.labelCounts = []
				vuethat.labelCounts = aa
			}),
			$(".imageLabel-delete").click(function() {
				var labelId = s.attr("labelId")
				var labelIdIndex = vuethat.labelIds.indexOf(labelId)
				var imageIndex = s.attr("imageIndex")
				if(vuethat.labelCounts[labelIdIndex].length > 1) {
					vuethat.labelCounts[labelIdIndex].splice(imageIndex, 1)
					$(".imageLabel-imgdrop[labelId=" + labelId + "]").each(function(i, v) {
						if($(v).attr("imageIndex") > imageIndex) {
							var a = $(v).attr("imageIndex") - 1
							$(v).attr("imageIndex", a)
						}
					})
				} else {
					vuethat.labelIds.splice(labelIdIndex, 1)
					vuethat.labelNames.splice(labelIdIndex, 1)
					vuethat.labelCounts.splice(labelIdIndex, 1)
				}
				s.remove()
				f.hide()
			}),
			$(".imageLabel-edit").click(function() {
				n.edit(s), s.addClass("imageLabel-drop-edit").siblings().removeClass("imageLabel-drop-edit")
				var image_name = JSON.parse(s.attr("data-json"))
				n.editPop && (y.addClass("imageLabel-active").find("input").val(image_name.name),
					setTimeout(function() {
						y.find("input").focus()[0].setSelectionRange(-1, -1)
					}, 500))
				f.hide()
			}),
			u.keydown(function(e) {
				13 == e.keyCode && y.find(".imageLabel-input-ok").click()
			}),
			$(window).keydown(function(e) {
				27 == e.keyCode && y.hasClass("imageLabel-active") && y.removeClass("imageLabel-active")
			}),
			a(),
			$(window).resize(a)
		$(".imageLabel-closes").click(function() {
			n.close(i.getData())
			alert(JSON.stringify(i.getData()))
		})
	}
	var i = {
			getData: function() {
				var e = [];
				return $(".imageLabel-imgdrop").each(function() {
					e.push(JSON.parse($(this).attr("data-json")))
				}), e
			},
			clearArea: function() {
				$(".imageLabel-imgdrop").remove()
			},
			close: function() {
				$(".imageLabel-closes").click()
			}
		},

		n = {
			only: !1,
			shade: !1,
			editPop: !0,
			close: function() {
				return !0
			},
			edit: function() {},
			confirm: function() {
				return !0
			},
			startArea: function() {},
			clickArea: function() {},
			data: []
		};
	n = $.extend(n, e)
	var l = $(".imageLabel-box");
	$(".imageLabel-box .imageLabel-img").addClass("imageLabel-img-active")
	$(".imageLabel-loading-body").hide()
	a()
}
export {
	imageLabel
}